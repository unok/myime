name: Build Swift DLL

on:
  workflow_dispatch:
  push:
    paths:
      - 'src/swift-engine/**'
      - 'src/AzooKeyKanaKanjiConverter/**'
      - 'src/swift-tokenizers/**'
      - '.github/workflows/build-swift-dll.yml'
  pull_request:
    paths:
      - 'src/swift-engine/**'
      - 'src/AzooKeyKanaKanjiConverter/**'
      - 'src/swift-tokenizers/**'
      - '.github/workflows/build-swift-dll.yml'

jobs:
  build-x64:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Swift
        uses: compnerd/gha-setup-swift@main
        with:
          branch: swift-6.1-release
          tag: 6.1-RELEASE

      - name: Cache Swift PM
        uses: actions/cache@v4
        with:
          path: |
            src/swift-engine/.build
            ~\AppData\Local\org.swift.swiftpm
          key: swift-pm-x64-${{ hashFiles('src/swift-engine/Package.resolved', 'src/AzooKeyKanaKanjiConverter/Package.resolved') }}
          restore-keys: |
            swift-pm-x64-

      - name: Build Swift DLL
        shell: pwsh
        run: |
          cd src/swift-engine
          swift build -c release

      - name: Collect artifacts
        shell: pwsh
        run: |
          $releaseDir = "src/swift-engine/.build/release"
          $outputDir = "artifacts/x64"
          New-Item -ItemType Directory -Force -Path $outputDir

          # Copy azookey-engine.dll
          Copy-Item "$releaseDir/azookey-engine.dll" $outputDir/

          # Copy Swift runtime DLLs from Swift installation
          $swiftBin = (Get-Command swift).Source | Split-Path -Parent
          $runtimeDlls = @(
            "swiftCore.dll",
            "swiftCRT.dll",
            "swiftDispatch.dll",
            "swift_Concurrency.dll",
            "swiftWinSDK.dll",
            "Foundation.dll",
            "FoundationEssentials.dll",
            "FoundationInternationalization.dll",
            "_FoundationICU.dll",
            "BlocksRuntime.dll",
            "dispatch.dll"
          )
          foreach ($dll in $runtimeDlls) {
            $dllPath = Join-Path $swiftBin $dll
            if (Test-Path $dllPath) {
              Copy-Item $dllPath $outputDir/
            }
          }

          # List collected files
          Get-ChildItem $outputDir

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: azookey-engine-x64
          path: artifacts/x64/
          retention-days: 90

  build-arm64:
    runs-on: windows-11-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Swift
        uses: compnerd/gha-setup-swift@main
        with:
          branch: swift-6.1-release
          tag: 6.1-RELEASE

      - name: Cache Swift PM
        uses: actions/cache@v4
        with:
          path: |
            src/swift-engine/.build
            ~\AppData\Local\org.swift.swiftpm
          key: swift-pm-arm64-${{ hashFiles('src/swift-engine/Package.resolved', 'src/AzooKeyKanaKanjiConverter/Package.resolved') }}
          restore-keys: |
            swift-pm-arm64-

      - name: Build Swift DLL
        shell: pwsh
        run: |
          cd src/swift-engine
          swift build -c release

      - name: Collect artifacts
        shell: pwsh
        run: |
          $releaseDir = "src/swift-engine/.build/release"
          $outputDir = "artifacts/arm64"
          New-Item -ItemType Directory -Force -Path $outputDir

          # Copy azookey-engine.dll
          Copy-Item "$releaseDir/azookey-engine.dll" $outputDir/

          # Copy Swift runtime DLLs from Swift installation
          $swiftBin = (Get-Command swift).Source | Split-Path -Parent
          $runtimeDlls = @(
            "swiftCore.dll",
            "swiftCRT.dll",
            "swiftDispatch.dll",
            "swift_Concurrency.dll",
            "swiftWinSDK.dll",
            "Foundation.dll",
            "FoundationEssentials.dll",
            "FoundationInternationalization.dll",
            "_FoundationICU.dll",
            "BlocksRuntime.dll",
            "dispatch.dll"
          )
          foreach ($dll in $runtimeDlls) {
            $dllPath = Join-Path $swiftBin $dll
            if (Test-Path $dllPath) {
              Copy-Item $dllPath $outputDir/
            }
          }

          # List collected files
          Get-ChildItem $outputDir

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: azookey-engine-arm64
          path: artifacts/arm64/
          retention-days: 90
