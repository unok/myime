name: Build Swift DLL

on:
  workflow_dispatch:
  push:
    paths:
      - 'src/swift-engine/**'
      - 'src/AzooKeyKanaKanjiConverter/**'
      - 'src/swift-tokenizers/**'
      - '.github/workflows/build-swift-dll.yml'
  pull_request:
    paths:
      - 'src/swift-engine/**'
      - 'src/AzooKeyKanaKanjiConverter/**'
      - 'src/swift-tokenizers/**'
      - '.github/workflows/build-swift-dll.yml'

jobs:
  # Prepare job: fetch dependencies on x64 (stable network)
  prepare:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache submodules
        id: cache-submodules
        uses: actions/cache@v4
        with:
          path: |
            mozc
            dictionaries
            src/AzooKeyKanaKanjiConverter/Sources/KanaKanjiConverterModuleWithDefaultDictionary/azooKey_dictionary_storage
            src/AzooKeyKanaKanjiConverter/Sources/KanaKanjiConverterModuleWithDefaultDictionary/azooKey_emoji_dictionary_storage
          key: submodules-${{ hashFiles('.gitmodules') }}

      - name: Initialize submodules
        if: steps.cache-submodules.outputs.cache-hit != 'true'
        run: git submodule update --init --recursive --depth=1

      - name: Install Swift
        uses: compnerd/gha-setup-swift@main
        with:
          branch: swift-6.1-release
          tag: 6.1-RELEASE

      - name: Resolve Swift dependencies
        shell: pwsh
        run: |
          cd src/swift-engine
          swift package resolve

      - name: Create tarball of Swift dependencies
        shell: pwsh
        run: |
          cd src/swift-engine
          tar -czf swift-deps.tar.gz .build/checkouts .build/repositories .build/workspace-state.json
          Move-Item swift-deps.tar.gz $env:GITHUB_WORKSPACE/

      - name: Upload Swift dependencies artifact
        uses: actions/upload-artifact@v4
        with:
          name: swift-deps
          path: swift-deps.tar.gz
          retention-days: 1

  build-x64:
    runs-on: windows-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore submodules cache
        uses: actions/cache/restore@v4
        with:
          path: |
            mozc
            dictionaries
            src/AzooKeyKanaKanjiConverter/Sources/KanaKanjiConverterModuleWithDefaultDictionary/azooKey_dictionary_storage
            src/AzooKeyKanaKanjiConverter/Sources/KanaKanjiConverterModuleWithDefaultDictionary/azooKey_emoji_dictionary_storage
          key: submodules-${{ hashFiles('.gitmodules') }}

      - name: Initialize submodules if cache missed
        run: |
          if (!(Test-Path "mozc/.git")) {
            git submodule update --init --recursive --depth=1
          }
        shell: pwsh

      - name: Install Swift
        uses: compnerd/gha-setup-swift@main
        with:
          branch: swift-6.1-release
          tag: 6.1-RELEASE

      - name: Download Swift dependencies
        uses: actions/download-artifact@v4
        with:
          name: swift-deps
          path: .

      - name: Extract Swift dependencies
        shell: pwsh
        run: |
          cd src/swift-engine
          tar -xzf $env:GITHUB_WORKSPACE/swift-deps.tar.gz
          Write-Host "Extracted files:"
          Get-ChildItem -Recurse .build | Select-Object -First 20

      - name: Build Swift DLL
        shell: pwsh
        run: |
          cd src/swift-engine
          swift build -c release

      - name: Collect artifacts
        shell: pwsh
        run: |
          $releaseDir = "src/swift-engine/.build/release"
          $outputDir = "artifacts/x64"
          New-Item -ItemType Directory -Force -Path $outputDir

          # Copy azookey-engine.dll
          Copy-Item "$releaseDir/azookey-engine.dll" $outputDir/

          # Copy Swift runtime DLLs from Swift installation
          $swiftBin = (Get-Command swift).Source | Split-Path -Parent
          $runtimeDlls = @(
            "swiftCore.dll",
            "swiftCRT.dll",
            "swiftDispatch.dll",
            "swift_Concurrency.dll",
            "swiftWinSDK.dll",
            "Foundation.dll",
            "FoundationEssentials.dll",
            "FoundationInternationalization.dll",
            "_FoundationICU.dll",
            "BlocksRuntime.dll",
            "dispatch.dll"
          )
          foreach ($dll in $runtimeDlls) {
            $dllPath = Join-Path $swiftBin $dll
            if (Test-Path $dllPath) {
              Copy-Item $dllPath $outputDir/
            }
          }

          # List collected files
          Get-ChildItem $outputDir

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: azookey-engine-x64
          path: artifacts/x64/
          retention-days: 90

  build-arm64:
    runs-on: windows-11-arm
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore submodules cache
        uses: actions/cache/restore@v4
        with:
          path: |
            mozc
            dictionaries
            src/AzooKeyKanaKanjiConverter/Sources/KanaKanjiConverterModuleWithDefaultDictionary/azooKey_dictionary_storage
            src/AzooKeyKanaKanjiConverter/Sources/KanaKanjiConverterModuleWithDefaultDictionary/azooKey_emoji_dictionary_storage
          key: submodules-${{ hashFiles('.gitmodules') }}

      - name: Initialize submodules if cache missed
        run: |
          if (!(Test-Path "mozc/.git")) {
            git submodule update --init --recursive --depth=1
          }
        shell: pwsh

      - name: Install Swift
        uses: compnerd/gha-setup-swift@main
        with:
          branch: swift-6.1-release
          tag: 6.1-RELEASE

      - name: Download Swift dependencies
        uses: actions/download-artifact@v4
        with:
          name: swift-deps
          path: .

      - name: Extract Swift dependencies
        shell: pwsh
        run: |
          cd src/swift-engine
          tar -xzf $env:GITHUB_WORKSPACE/swift-deps.tar.gz
          Write-Host "Extracted files:"
          Get-ChildItem -Recurse .build | Select-Object -First 20

      - name: Build Swift DLL
        shell: pwsh
        run: |
          cd src/swift-engine
          $maxRetries = 10
          $retryCount = 0
          $success = $false

          while (-not $success -and $retryCount -lt $maxRetries) {
            $retryCount++
            Write-Host "Attempt $retryCount of $maxRetries..."

            swift build -c release
            if ($LASTEXITCODE -eq 0) {
              $success = $true
              Write-Host "Build succeeded on attempt $retryCount"
            } else {
              Write-Host "Build failed with exit code $LASTEXITCODE, retrying..."
              Start-Sleep -Seconds 10
            }
          }

          if (-not $success) {
            Write-Host "Build failed after $maxRetries attempts"
            exit 1
          }

      - name: Collect artifacts
        shell: pwsh
        run: |
          $releaseDir = "src/swift-engine/.build/release"
          $outputDir = "artifacts/arm64"
          New-Item -ItemType Directory -Force -Path $outputDir

          # Copy azookey-engine.dll
          Copy-Item "$releaseDir/azookey-engine.dll" $outputDir/

          # Copy Swift runtime DLLs from Swift installation
          $swiftBin = (Get-Command swift).Source | Split-Path -Parent
          $runtimeDlls = @(
            "swiftCore.dll",
            "swiftCRT.dll",
            "swiftDispatch.dll",
            "swift_Concurrency.dll",
            "swiftWinSDK.dll",
            "Foundation.dll",
            "FoundationEssentials.dll",
            "FoundationInternationalization.dll",
            "_FoundationICU.dll",
            "BlocksRuntime.dll",
            "dispatch.dll"
          )
          foreach ($dll in $runtimeDlls) {
            $dllPath = Join-Path $swiftBin $dll
            if (Test-Path $dllPath) {
              Copy-Item $dllPath $outputDir/
            }
          }

          # List collected files
          Get-ChildItem $outputDir

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: azookey-engine-arm64
          path: artifacts/arm64/
          retention-days: 90
